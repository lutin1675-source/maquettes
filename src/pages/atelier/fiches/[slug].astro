---
import Layout from '../../../layouts/Layout.astro';
import SiteChrome from '../../../components/SiteChrome.astro';
import SectionSidebar from '../../../components/SectionSidebar.astro';
import { getCollection } from 'astro:content';
import { renderMarkdown } from '../../../lib/markdown';
import { slugify } from '../../../lib/slug';

export async function getStaticPaths() {
	const entries = await getCollection('atelier-models');
	return entries.map((entry) => ({
		params: { slug: entry.slug },
		props: { slug: entry.slug },
	}));
}

const { slug } = Astro.props as { slug: string };
const entries = await getCollection('atelier-models');
const models = entries.sort((a, b) => a.data.title.localeCompare(b.data.title));
const currentIndex = models.findIndex((entry) => entry.slug === slug);
if (currentIndex === -1) {
	throw new Error(`Fiche atelier introuvable : ${slug}`);
}
const entry = models[currentIndex];
const { data } = entry;
const base = import.meta.env.BASE_URL || '/';
const navPages = models.map((item) => ({
	slug: item.slug,
	title: item.data.title,
}));
const previousPage = currentIndex > 0 ? navPages[currentIndex - 1] : null;
const nextPage = currentIndex < navPages.length - 1 ? navPages[currentIndex + 1] : null;
const docSections = data.sections.map((section) => ({
	...section,
	html: renderMarkdown(section.body),
}));
const sidebarSections = [{ id: 'introduction', title: 'Introduction' }, ...docSections.map((section) => ({ id: section.id, title: section.title }))];
const flowSections = ['introduction', ...docSections.map((section) => section.id)];
const nextTargets = flowSections.reduce<Record<string, { href: string; label: string }>>((acc, sectionId, index) => {
	const nextSectionId = flowSections[index + 1];
	const nextSectionTitle = sidebarSections.find((section) => section.id === nextSectionId)?.title;
	if (nextSectionId && nextSectionTitle) {
		acc[sectionId] = { href: `#${nextSectionId}`, label: `Section suivante : ${nextSectionTitle}` };
	} else if (nextPage) {
		acc[sectionId] = { href: `${base}atelier/fiches/${nextPage.slug}/`, label: `Fiche suivante : ${nextPage.title}` };
	} else {
		acc[sectionId] = { href: `${base}atelier/fiches/`, label: 'Retour aux fiches' };
	}
	return acc;
}, {});
const breadcrumbs = [
	{ label: 'Accueil', href: base },
	{ label: 'L’Atelier', href: `${base}atelier/` },
	{ label: 'Fiches atelier', href: `${base}atelier/fiches/` },
	{ label: data.title },
];
---

<Layout title={data.title} description={data.summary}>
	<SiteChrome className="space-y-8">
		<nav class="text-xs uppercase tracking-[0.35em] text-[var(--tm-muted)]">
			{breadcrumbs.map((crumb, index) => (
				<span>
					{crumb.href ? (
						<a class={index === breadcrumbs.length - 1 ? 'text-[var(--tm-text)]' : 'text-[var(--tm-lagoon)]'} href={crumb.href}>
							{crumb.label}
						</a>
					) : (
						<span>{crumb.label}</span>
					)}
					{index < breadcrumbs.length - 1 ? <span class="px-2 text-[var(--tm-muted)]/60">/</span> : null}
				</span>
			))}
		</nav>

		<section class="tm-panel rounded-xl p-8">
			<p class="section-label text-[var(--tm-lagoon)]">Fiche atelier</p>
			<h1 class="mt-3 text-4xl leading-tight">{data.title}</h1>
			<div class="mt-4 grid gap-4 md:grid-cols-2">
				<ul class="space-y-2 text-sm text-[var(--tm-muted)]">
					<li>
						<strong>Fabricant :</strong> {data.manufacturer || '—'}
					</li>
					<li>
						<strong>Référence :</strong> {data.reference || '—'}
					</li>
					<li>
						<strong>Échelle :</strong> {data.scale || '—'}
					</li>
				</ul>
				<p class="text-[var(--tm-muted)]">{data.summary}</p>
				{data.tags?.length ? (
					<ul class="md:col-span-2 flex flex-wrap gap-2 text-[0.65rem] uppercase tracking-[0.3em] text-[var(--tm-muted)]">
						{data.tags.map((tag) => (
							<li>
								<a class="rounded-full border border-white/15 px-3 py-1 hover:text-[var(--tm-lumen)]" href={`${base}atelier/fiches/tag/${slugify(tag)}/`}>
									{tag}
								</a>
							</li>
						))}
					</ul>
				) : null}
			</div>
		</section>

		<section class="tm-article-layout">
			<SectionSidebar currentSlug={slug} sections={sidebarSections} pages={navPages} basePath="atelier/fiches" />
			<div class="space-y-6">
				<section id="introduction" class="tm-panel rounded-xl p-8">
					<p class="text-[var(--tm-muted)]">{data.intro}</p>
					{nextTargets.introduction ? (
						<div class="mt-6 flex justify-end">
							<a class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.4em] text-[var(--tm-lagoon)]" href={nextTargets.introduction.href}>
								{nextTargets.introduction.label} →
							</a>
						</div>
					) : null}
				</section>

				{docSections.map((section) => (
					<section id={section.id} class="tm-panel scroll-mt-32 rounded-xl p-8">
						<h2 class="text-3xl leading-tight">{section.title}</h2>
						<div class="mt-5 prose prose-invert max-w-none" set:html={section.html} />
						{nextTargets[section.id] ? (
							<div class="mt-6 flex justify-end">
								<a class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.4em] text-[var(--tm-lagoon)]" href={nextTargets[section.id].href}>
									{nextTargets[section.id].label} →
								</a>
							</div>
						) : null}
					</section>
				))}

				{data.sources?.length ? (
					<section class="tm-panel rounded-xl p-8">
						<h2 class="text-3xl leading-tight">Sources</h2>
						<ul class="mt-5 space-y-2 text-sm text-[var(--tm-muted)]">
							{data.sources.map((source) => (
								<li>• {source}</li>
							))}
						</ul>
					</section>
				) : null}
			</div>
		</section>

		<nav class="flex flex-wrap items-center justify-between gap-4">
			{previousPage ? (
				<a class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.45em] text-[var(--tm-muted)] hover:text-[var(--tm-lumen)]" href={`${base}atelier/fiches/${previousPage.slug}/`}>
					← {previousPage.title}
				</a>
			) : (
				<a class="text-xs uppercase tracking-[0.45em] text-[var(--tm-muted)] hover:text-[var(--tm-lumen)]" href={`${base}atelier/fiches/`}>
					← Retour aux fiches
				</a>
			)}
			{nextPage ? (
				<a class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.45em] text-[var(--tm-lagoon)]" href={`${base}atelier/fiches/${nextPage.slug}/`}>
					{nextPage.title} →
				</a>
			) : (
				<a class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.45em] text-[var(--tm-lagoon)]" href={`${base}atelier/fiches/`}>
					Fin de parcours →
				</a>
			)}
		</nav>
	</SiteChrome>
</Layout>
